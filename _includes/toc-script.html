<!-- 目录生成和高亮脚本 -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 生成目录
        generateTableOfContents();

        // 滚动时高亮当前章节
        window.addEventListener('scroll', highlightCurrentSection);
    });

    function generateTableOfContents() {
        const tocContainer = document.querySelector('.table-of-contents');
        if (!tocContainer) return;

        const headings = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .page-content-body h1, .page-content-body h2, .page-content-body h3, .page-content-body h4');
        if (headings.length === 0) {
            tocContainer.style.display = 'none';
            return;
        }

        let tocHTML = '<div class="toc-title">目录</div><ul class="toc-list">';
        let currentLevel = 1;
        let stack = [];

        headings.forEach((heading, index) => {
            const level = parseInt(heading.tagName.charAt(1));
            const text = heading.textContent;
            const id = 'heading-' + index;
            heading.id = id;

            // 处理嵌套层级
            if (level > currentLevel) {
                for (let i = currentLevel; i < level; i++) {
                    tocHTML += '<ul class="toc-list">';
                    stack.push('</ul>');
                }
            } else if (level < currentLevel) {
                const diff = currentLevel - level;
                for (let i = 0; i < diff; i++) {
                    tocHTML += stack.pop() || '';
                }
            }

            tocHTML += `<li><a href="#${id}" class="toc-link">${text}</a></li>`;
            currentLevel = level;
        });

        // 关闭所有未关闭的嵌套列表
        while (stack.length > 0) {
            tocHTML += stack.pop();
        }

        tocHTML += '</ul>';
        tocContainer.innerHTML = tocHTML;

        // 添加平滑滚动，计算固定页首高度偏移
        document.querySelectorAll('.toc-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    // 计算目标位置，减去固定页首的高度
                    const headerHeight = 100; // 固定页首高度 + 缓冲空间
                    const targetPosition = targetElement.offsetTop - headerHeight;

                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                }
            });
        });
    }

    function highlightCurrentSection() {
        const tocLinks = document.querySelectorAll('.toc-link');
        const headings = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .page-content-body h1, .page-content-body h2, .page-content-body h3, .page-content-body h4');

        let currentSection = null;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        // 找到当前可视区域的标题，考虑固定页首高度
        const headerHeight = 100;
        headings.forEach(heading => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= headerHeight) {
                currentSection = heading.id;
            }
        });

        // 更新目录高亮
        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (currentSection && link.getAttribute('href') === '#' + currentSection) {
                link.classList.add('active');
            }
        });
    }
</script>